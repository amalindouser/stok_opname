<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>üì¶ Stok Opname Barang</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      margin: 40px;
      background: #f9f9f9;
    }
    h2 {
      color: #2c3e50;
      text-align: center;
    }
    form {
      text-align: center;
      margin-bottom: 20px;
    }
    input[type="text"] {
      padding: 10px;
      width: 300px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      padding: 8px 14px;
      margin: 5px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    button.scan { background: #007bff; color: white; }
    button.save { background: #28a745; color: white; }
    button.pdf { background: #17a2b8; color: white; }
    button.delete { background: #dc3545; color: white; }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      background: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #007bff;
      color: white;
    }
    td[contenteditable="true"] {
      background: #fcfcfc;
    }
  </style>
</head>
<body>
  <h2>üì¶ Aplikasi Stok Opname Barang</h2>

  <form id="scanForm">
    <input type="text" id="kode" placeholder="üîç Scan atau masukkan kode barang" autofocus required>
    <button class="scan" type="submit">Tambah</button>
  </form>

  <table id="opnameTable">
    <thead>
      <tr>
        <th>Kode</th>
        <th>Nama Barang</th>
        <th>Stok Sistem</th>
        <th>Stok Fisik</th>
        <th>Selisih</th>
        <th>Keterangan</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div style="text-align:center; margin-top:20px;">
    <button class="save" id="btnSave">üíæ Simpan ke Database</button>
    <button class="pdf" id="btnPdf">üñ®Ô∏è Cetak PDF</button>
  </div>

  <script>
    const items = [];
    const tableBody = document.querySelector("#opnameTable tbody");

    document.getElementById("scanForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const kode = document.getElementById("kode").value.trim();
      if (!kode) return;

      const res = await fetch("/scan", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: "kode=" + encodeURIComponent(kode)
      });

      const data = await res.json();
      if (data.error) {
        alert(data.error);
        return;
      }

      const fisik = prompt(`Masukkan jumlah fisik untuk ${data.nama} (stok sistem: ${data.on_hand})`);
      if (fisik === null || fisik === "") return;

      const selisih = fisik - data.on_hand;
      const newItem = {
        kode: data.kode,
        nama: data.nama,
        on_hand: data.on_hand,
        fisik,
        selisih,
        keterangan: "",
        departemen: data.departemen
      };

      items.push(newItem);
      renderTable();
      document.getElementById("kode").value = "";
      document.getElementById("kode").focus();
    });

    function renderTable() {
      tableBody.innerHTML = "";
      items.forEach((item, i) => {
        tableBody.innerHTML += `
          <tr>
            <td>${item.kode}</td>
            <td>${item.nama}</td>
            <td>${item.on_hand}</td>
            <td>${item.fisik}</td>
            <td>${item.selisih}</td>
            <td contenteditable="true" oninput="items[${i}].keterangan=this.innerText">${item.keterangan}</td>
            <td><button class="delete" onclick="hapus(${i})">Hapus</button></td>
          </tr>`;
      });
    }

    function hapus(i) {
      items.splice(i, 1);
      renderTable();
    }

    document.getElementById("btnSave").addEventListener("click", async () => {
      if (!items.length) return alert("Belum ada data opname untuk disimpan.");
      const res = await fetch("/save_opname", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ items })
      });
      const data = await res.json();
      alert(data.message);
      if (res.ok) items.length = 0, renderTable();
    });

    document.getElementById("btnPdf").addEventListener("click", async () => {
      if (!items.length) return alert("Belum ada data opname untuk dicetak.");
      const res = await fetch("/cetak_pdf", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ items })
      });
      if (res.ok) {
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        window.open(url);
      }
    });
  </script>
</body>
</html>
