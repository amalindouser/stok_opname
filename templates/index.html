<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Stok Opname Modern</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f4f6f8; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 30px; }
    h2 { color: #2c3e50; margin-bottom: 20px; }
    .card { padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 30px; }
    table th { background-color: #007bff; color: white; }
    table td, table th { vertical-align: middle !important; text-align: center; }
    td[contenteditable="true"] { background-color: #fff9e6; border-radius: 4px; padding: 3px; }
    button { min-width: 120px; }
    .btn-save { background-color: #28a745; color: white; }
    .btn-pdf { background-color: #17a2b8; color: white; }
    .btn-delete { background-color: #dc3545; color: white; }
    .table-responsive { max-height: 400px; overflow-y: auto; }
  </style>
</head>
<body>

<div class="container">
  <h2>üì¶ Stok Opname Modern</h2>

  <!-- Upload Database -->
  <div class="card" id="uploadCard">
    <form id="uploadForm" class="d-flex gap-2 align-items-center">
      <input type="file" id="dbfile" class="form-control" accept=".accdb" required>
      <button type="submit" class="btn btn-primary">‚¨ÜÔ∏è Upload Database</button>
    </form>
  </div>

  <!-- Scan Barang Card (hidden sampai DB di-upload) -->
  <div class="card" id="scanCard" style="display:none;">
    <form id="scanForm" class="d-flex gap-2 align-items-center">
      <input type="text" id="kode" class="form-control" placeholder="Scan / Masukkan Kode Barang" required>
      <button type="submit" class="btn btn-primary">üîç Scan</button>
    </form>
  </div>

  <!-- Tabel Opname -->
  <div class="card table-responsive" id="tableCard" style="display:none;">
    <table class="table table-striped table-bordered" id="opnameTable">
      <thead>
        <tr>
          <th>Barcode</th>
          <th>Nama Barang</th>
          <th>Fisik</th>
          <th>On Hand</th>
          <th>Keterangan</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Tombol Aksi -->
  <div class="d-flex gap-2" id="actionButtons" style="display:none;">
    <button class="btn btn-save" id="btnSave">üíæ Simpan</button>
    <button class="btn btn-pdf" id="btnPdf">üñ®Ô∏è Cetak PDF</button>
  </div>
</div>

<script>
const tableBody = document.querySelector("#opnameTable tbody");
const items = [];

// ===== Upload Database =====
document.getElementById("uploadForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const fileInput = document.getElementById("dbfile");
  if (!fileInput.files.length) return alert("Pilih file database terlebih dahulu.");

  const formData = new FormData();
  formData.append("dbfile", fileInput.files[0]);

  try {
    const res = await fetch("/upload_db", {
      method: "POST",
      body: formData
    });
    const data = await res.json();
    if (data.error) return alert(data.error);

    alert(data.message);
    document.getElementById("uploadCard").style.display = "none";
    document.getElementById("scanCard").style.display = "block";
    document.getElementById("tableCard").style.display = "block";
    document.getElementById("actionButtons").style.display = "flex";
  } catch(err) {
    alert("Terjadi kesalahan: " + err);
  }
});

// ===== Scan Barang =====
document.getElementById("scanForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const kode = document.getElementById("kode").value.trim();
  if (!kode) return;

  try {
    const res = await fetch("/scan", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: "kode=" + encodeURIComponent(kode)
    });
    const data = await res.json();
    if (data.error) return alert(data.error);

    const fisik = prompt(`Masukkan jumlah fisik untuk ${data.nama}:`, data.on_hand);
    if (fisik === null) return;

    const newItem = { kode: data.kode, nama: data.nama, on_hand: data.on_hand, fisik, keterangan: "", departemen: data.departemen };
    items.push(newItem);
    renderTable();
    document.getElementById("kode").value = "";
  } catch(err) {
    alert("Terjadi kesalahan: " + err);
  }
});

// ===== Render Table =====
function renderTable() {
  tableBody.innerHTML = "";
  items.forEach((item, i) => {
    tableBody.innerHTML += `
      <tr>
        <td>${item.kode}</td>
        <td>${item.nama}</td>
        <td>${item.fisik}</td>
        <td>${item.on_hand}</td>
        <td contenteditable="true" oninput="items[${i}].keterangan=this.innerText">${item.keterangan}</td>
        <td><button class="btn btn-delete btn-sm" onclick="hapus(${i})">Hapus</button></td>
      </tr>`;
  });
}

function hapus(i) {
  items.splice(i, 1);
  renderTable();
}

// ===== Simpan ke Database =====
document.getElementById("btnSave").addEventListener("click", async () => {
  if (!items.length) return alert("Belum ada data opname.");
  const res = await fetch("/save_opname", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ items })
  });
  const data = await res.json();
  alert(data.message);
});

// ===== Cetak PDF =====
document.getElementById("btnPdf").addEventListener("click", async () => {
  if (!items.length) return alert("Belum ada data opname.");
  const res = await fetch("/cetak_pdf", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ items })
  });
  if (res.ok) {
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    window.open(url);
  }
});
</script>

</body>
</html>
